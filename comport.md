# Управление аппаратными узлами посредством COM-порта

Управление узлами через COM-порт является одной из наиболее критичных задач для управляющего ПО устройствами банковского самообслуживания. Не смотря на кажущуюся простоту задачи, с ней связано большое количество "подводных камней" и инженерных вызовов.

Принимая технические решения, следует найти ответы на такие вопросы как:

-	Актуальна ли переносимость библиотеки работы с COM-портом?
-	Будут ли команды к устройству отправляться из разных потоков исполнения (см. multithreading)?
-	Будут ли использоваться разные типы запросов, например: отправка команды на исполнение и систематический опрос состояния устройства. Если ответ "будут", то каким образом следует прерывать систематический опрос состояния устройств для отправки команд?
- Должен ли API класса работы с устройством через COM-порт быть асинхронным для прикладного программист?
-	Нужно ли использовать низкоуровневый код, или следует использовать переносимую, высокоуровневую библиотеку?
-	Какие образом будет осуществляться борьбя с зависаниями: устройства, драйвера порта

Принимая во внимание опыт специалистов КБ ДОРС при разработке кода взамиодействия с узлами через COM-порт, можно говорить о том, что используется следующие подходы:

- для записи и чтения в порт используются функции файлового ввода/вывода. Для Windows: CreateFile(), CloseHandle(), WriteFile(), ReadFile(). Для Linux: open(), close(), read(), write()
- для настройки порта используется API конкретной операционной системы. Для Windows: структуры DCB и COMSTAT, функции: GetCommState(), SetCommState(), GetOverlappedResult(), SetCommTimeouts(), CancelIo(). Для Linux может использоваться библиотека **termios**
- часто используется многопоточная модель, в которой есть отдельный поток polling-а устройства с целью кэширования актуального состояния узла. Для выполнения команды используется второй поток. Коммуникационный порт является разделяемым ресурсом, доступ к которому организуется посредством объектов синхронизации операционной системы (чаще всего - mutex)
- в потоке polling-а может использоваться фильтрация данных, например, могут извлекаться и анализироваться логи работы устройства
